<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commander Randomizer - Game Mode</title>
    
    <meta property="og:title" content="Commander Randomizer - Game Mode">
    <meta property="og:description" content="Multiplayer commander randomizer with powerups! 🎲">
    <meta property="og:type" content="website">
    
    <link rel="icon" type="image/png" href="images/randomizer-icon.png">
    <link rel="stylesheet" href="css/style.css?v=3.8">
    
    <style>
        /* Game Mode Specific Styles */
        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
            color: white;
        }

        .game-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .session-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .session-code {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .lobby-section {
            background: var(--card-bg, #1a1a1a);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .lobby-players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .lobby-player {
            background: var(--input-bg, #2a2a2a);
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .lobby-player.active {
            border: 2px solid var(--accent-color, #58a6ff);
        }

        .player-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .player-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .commander-img-large {
                width: 150px;
            }
            
            .commander-item-large {
                padding: 1rem;
            }
            
            .locked-commander-display h3 {
                font-size: 1.1rem;
            }
        }

        .player-section {
            background: var(--card-bg, #1a1a1a);
            border: 2px solid var(--border-color, #333);
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }

        .player-section.current-player {
            border-color: var(--accent-color, #58a6ff);
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }

        .player-section.locked {
            border-color: #4caf50;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color, #333);
        }

        .player-number {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .player-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .powerup-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .powerup-display.common {
            background: linear-gradient(135deg, #616161 0%, #9e9e9e 100%);
        }

        .powerup-display.uncommon {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
        }

        .powerup-display.rare {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
        }

        .powerup-display.mythic {
            background: linear-gradient(135deg, #d84315 0%, #ff6f00 100%);
        }

        .powerup-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .powerup-description {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .player-settings {
            background: var(--input-bg, #2a2a2a);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            font-weight: bold;
            min-width: 80px;
        }

        .quantity-display {
            font-size: 1.1rem;
        }

        .quantity-modifier {
            color: var(--accent-color, #58a6ff);
            font-size: 0.9rem;
        }

        .color-filter-inline {
            display: flex;
            gap: 0.5rem;
        }

        .color-symbol {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .color-symbol.W { background: #f9faf4; color: #000; }
        .color-symbol.U { background: #0e68ab; color: #fff; }
        .color-symbol.B { background: #150b00; color: #fff; }
        .color-symbol.R { background: #d3202a; color: #fff; }
        .color-symbol.G { background: #00733e; color: #fff; }

        .color-symbol.selected {
            border-color: var(--accent-color, #58a6ff);
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
        }

        .color-symbol.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .commander-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.8rem;
            margin: 1rem 0;
        }

        .commander-item-small {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .commander-checkbox-container {
            width: 100%;
            margin-top: -4px;
        }

        .commander-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 0 0 6px 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            line-height: 1.3;
            min-height: 40px;
        }

        .commander-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color, #58a6ff);
        }

        .commander-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 2px;
        }

        .commander-name-label {
            flex: 1;
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .commander-img-small {
            width: 100%;
            height: auto;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .commander-img-small:hover {
            transform: scale(1.02);
        }

        .commander-item-small.selected .commander-checkbox-label {
            background: rgba(88, 166, 255, 0.2);
            border-color: var(--accent-color, #58a6ff);
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }

        .commander-item-small.selected .commander-img-small {
            border: 3px solid var(--accent-color, #58a6ff);
            border-bottom: none;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.5);
        }

        /* Locked Commander Display Styles */
        .locked-commander-display {
            text-align: center;
            padding: 1rem;
        }

        .locked-commander-display h3 {
            margin: 0 0 1rem 0;
            color: var(--accent-color, #58a6ff);
        }

        .commander-item-large {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--accent-color, #58a6ff);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(88, 166, 255, 0.3);
        }

        .commander-img-large {
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .commander-img-large:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(74, 144, 226, 0.5);
        }

        .commander-details {
            text-align: center;
        }

        .commander-details h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            color: var(--fg-color, #ffffff);
        }

        .commander-details p {
            margin: 0 0 1rem 0;
            opacity: 0.8;
        }

        .edhrec-link {
            color: var(--accent-color, #58a6ff);
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-color, #58a6ff);
            border-radius: 4px;
            transition: all 0.2s;
        }

        .edhrec-link:hover {
            background: rgba(88, 166, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Other Player Label Styles */
        .commander-checkbox-label.other-player {
            cursor: default;
            padding-left: 12px; /* Compensate for missing checkbox space */
        }

        .commander-checkbox-label.other-player:hover {
            background: rgba(255, 255, 255, 0.05); /* Less prominent hover */
        }

        .pack-codes-section {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            padding: 2rem;
            border-radius: 8px;
            color: white;
            text-align: center;
        }

        .pack-codes-section h2 {
            margin-top: 0;
        }

        .pack-code-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .pack-code-item {
            background: rgba(255,255,255,0.2);
            padding: 1rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pack-code {
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 0.1em;
        }

        .hidden {
            display: none !important;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Game Header -->
        <header class="game-header">
            <h1>🎲 Commander Randomizer - Game Mode</h1>
            <div class="session-info hidden" id="session-info">
                <span>Session Code:</span>
                <span class="session-code" id="session-code-display">-----</span>
                <button class="btn btn-small" id="copy-session-code">Copy</button>
                <button class="btn btn-small" id="leave-session">Leave Session</button>
            </div>
        </header>

        <!-- Join/Create Section -->
        <section id="join-create-section" class="lobby-section">
            <h2>Get Started</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                <div>
                    <h3>Host New Game</h3>
                    <input type="text" id="create-name-input" class="form-control" placeholder="Enter your name" maxlength="20" style="margin-bottom: 0.5rem;">
                    <button class="btn btn-primary" id="create-session-btn">Create Session</button>
                </div>
                <div>
                    <h3>Join Existing Game</h3>
                    <input type="text" id="join-name-input" class="form-control" placeholder="Enter your name" maxlength="20" style="margin-bottom: 0.5rem;">
                    <input type="text" id="join-code-input" class="form-control" placeholder="Enter session code" maxlength="5" style="margin-bottom: 0.5rem; text-transform: uppercase;">
                    <button class="btn btn-primary" id="join-session-btn">Join Session</button>
                </div>
            </div>
        </section>

        <!-- Lobby (before powerups rolled) -->
        <section id="lobby-section" class="lobby-section hidden">
            <h2>Lobby</h2>
            <div class="lobby-players" id="lobby-players">
                <!-- Player slots populated by JS -->
            </div>
            <button class="btn btn-primary" id="roll-powerups-btn">Start Game</button>
            <p style="margin-top: 1rem; opacity: 0.8;">Waiting for host to start the game...</p>
        </section>

        <!-- Player Grid (after powerups rolled) -->
        <section id="player-grid-section" class="hidden">
            <div class="player-grid" id="player-grid">
                <!-- Player sections populated by JS -->
            </div>
        </section>

        <!-- Pack Codes (when all locked in) -->
        <section id="pack-codes-section" class="pack-codes-section hidden">
            <h2>🎉 All Players Locked In!</h2>
            <p>Your pack codes are ready. Enter your code in TTS to receive your packs!</p>
            <div class="pack-code-list" id="pack-code-list">
                <!-- Pack codes populated by JS -->
            </div>
        </section>

        <!-- Status Message -->
        <div id="status-message" style="text-align: center; margin: 1rem 0; min-height: 24px;">
            <!-- Status messages appear here -->
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { SessionManager } from './js/game-session/sessionManager.js';
        import { PowerupLoader } from './js/game-session/powerupLoader.js';
        import { PackConfigGenerator } from './js/game-session/packConfigGenerator.js';
        import { GameModeController } from './js/game-session/gameModeController.js';
        import { getCsvInfo } from './js/dataLoader.js';

        // Initialize
        let sessionManager;
        let powerupLoader;
        let packConfigGenerator;
        let gameModeController;
        let currentSession = null;
        let currentPlayerId = null;
        let powerupsData = null;
        let playerCommandersGenerated = {}; // Track which players have generated commanders

        // DOM Elements
        const joinCreateSection = document.getElementById('join-create-section');
        const lobbySection = document.getElementById('lobby-section');
        const playerGridSection = document.getElementById('player-grid-section');
        const packCodesSection = document.getElementById('pack-codes-section');
        const sessionInfo = document.getElementById('session-info');
        const sessionCodeDisplay = document.getElementById('session-code-display');
        const createSessionBtn = document.getElementById('create-session-btn');
        const joinSessionBtn = document.getElementById('join-session-btn');
        const joinCodeInput = document.getElementById('join-code-input');
        const rollPowerupsBtn = document.getElementById('roll-powerups-btn');
        const copySessionCodeBtn = document.getElementById('copy-session-code');
        const leaveSessionBtn = document.getElementById('leave-session');
        const statusMessage = document.getElementById('status-message');

        async function init() {
            console.log('🎮 [INIT] Starting game mode initialization...');
            try {
                showStatus('Loading...');
                
                // Initialize managers
                console.log('🎮 [INIT] Creating SessionManager...');
                sessionManager = new SessionManager();
                
                console.log('🎮 [INIT] Creating PowerupLoader...');
                powerupLoader = new PowerupLoader();
                
                console.log('🎮 [INIT] Creating PackConfigGenerator...');
                packConfigGenerator = new PackConfigGenerator();
                
                // Load powerups
                console.log('📦 [INIT] Loading powerups data...');
                powerupsData = await powerupLoader.loadPowerups();
                console.log('✅ [INIT] Powerups loaded:', powerupsData.length, 'powerups');
                
                // Load CSV data for randomizer
                console.log('📊 [INIT] Loading CSV data...');
                await getCsvInfo();
                console.log('✅ [INIT] CSV data loaded');
                
                // Initialize game mode controller
                console.log('🎮 [INIT] Creating GameModeController...');
                gameModeController = new GameModeController(
                    sessionManager,
                    powerupLoader,
                    packConfigGenerator
                );
                console.log('✅ [INIT] GameModeController created');
                
                console.log('✅ [INIT] Initialization complete!');
                showStatus('Ready! Create or join a session.');
            } catch (error) {
                console.error('❌ [INIT] Initialization error:', error);
                showStatus('Error loading. Please refresh the page.');
            }
        }

        // Event Listeners
        createSessionBtn.addEventListener('click', async () => {
            console.log('🎲 [CREATE] Create session button clicked');
            
            const playerName = document.getElementById('create-name-input').value.trim();
            
            try {
                showStatus('Creating session...');
                console.log('📡 [CREATE] Calling sessionManager.createSession()...');
                const result = await sessionManager.createSession(playerName);
                console.log('✅ [CREATE] Session created:', result);
                
                currentSession = result.sessionData;
                currentPlayerId = result.playerId;
                console.log('💾 [CREATE] Stored session:', currentSession.sessionCode, 'playerId:', currentPlayerId);
                
                enterLobby();
            } catch (error) {
                console.error('❌ [CREATE] Create session error:', error);
                showStatus('Failed to create session. Please try again.');
            }
        });

        joinSessionBtn.addEventListener('click', async () => {
            const playerName = document.getElementById('join-name-input').value.trim();
            const code = joinCodeInput.value.trim().toUpperCase();
            console.log('🎲 [JOIN] Join session button clicked, code:', code);
            
            if (!code || code.length !== 5) {
                console.warn('⚠️ [JOIN] Invalid session code');
                showStatus('Please enter a valid 5-character session code.');
                return;
            }
            
            try {
                showStatus('Joining session...');
                console.log('📡 [JOIN] Calling sessionManager.joinSession()...');
                const result = await sessionManager.joinSession(code, playerName);
                console.log('✅ [JOIN] Joined session:', result);
                
                currentSession = result.sessionData;
                currentPlayerId = result.playerId;
                console.log('💾 [JOIN] Stored session:', currentSession.sessionCode, 'playerId:', currentPlayerId);
                
                enterLobby();
            } catch (error) {
                console.error('❌ [JOIN] Join session error:', error);
                showStatus('Failed to join session. Check the code and try again.');
            }
        });

        rollPowerupsBtn.addEventListener('click', async () => {
            console.log('🎲 [POWERUPS] Roll powerups button clicked');
            try {
                showStatus('Rolling powerups...');
                console.log('📡 [POWERUPS] Calling sessionManager.rollPowerups()...');
                const session = await sessionManager.rollPowerups(
                    currentSession.sessionCode,
                    currentPlayerId
                );
                console.log('✅ [POWERUPS] Powerups rolled:', session);
                
                currentSession = session;
                console.log('💾 [POWERUPS] Updated session state');
                
                enterGameMode();
            } catch (error) {
                console.error('❌ [POWERUPS] Roll powerups error:', error);
                showStatus('Failed to roll powerups. Please try again.');
            }
        });

        copySessionCodeBtn.addEventListener('click', () => {
            console.log('📋 [COPY] Copy session code clicked');
            navigator.clipboard.writeText(currentSession.sessionCode);
            console.log('✅ [COPY] Copied:', currentSession.sessionCode);
            showStatus('Session code copied!');
        });

        leaveSessionBtn.addEventListener('click', () => {
            console.log('🚪 [LEAVE] Leave session clicked');
            if (confirm('Are you sure you want to leave the session?')) {
                console.log('✅ [LEAVE] User confirmed, reloading page');
                location.reload();
            } else {
                console.log('❌ [LEAVE] User cancelled');
            }
        });

        function enterLobby() {
            console.log('🚪 [LOBBY] Entering lobby...');
            joinCreateSection.classList.add('hidden');
            lobbySection.classList.remove('hidden');
            sessionInfo.classList.remove('hidden');
            sessionCodeDisplay.textContent = currentSession.sessionCode;
            
            // Update controller
            console.log('🔄 [LOBBY] Updating controller state');
            gameModeController.currentSession = currentSession;
            gameModeController.currentPlayerId = currentPlayerId;
            
            updateLobbyPlayers();
            
            // Show roll button only for host
            const isHost = currentSession.hostId === currentPlayerId;
            console.log('👑 [LOBBY] Is host:', isHost);
            rollPowerupsBtn.style.display = isHost ? 'block' : 'none';
            
            // Start polling
            console.log('🔄 [LOBBY] Starting session polling');
            startPolling();
            console.log('✅ [LOBBY] Lobby entered successfully');
        }

        function updateLobbyPlayers() {
            const lobbyPlayers = document.getElementById('lobby-players');
            lobbyPlayers.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const player = currentSession.players[i];
                const div = document.createElement('div');
                div.className = 'lobby-player' + (player ? ' active' : '');
                
                if (player) {
                    const isYou = player.id === currentPlayerId;
                    const isHost = player.id === currentSession.hostId;
                    div.innerHTML = `
                        <strong>${player.name || `Player ${player.number}`}</strong>
                        ${isYou ? '<br>(You)' : ''}
                        ${isHost ? '<br>👑 Host' : ''}
                    `;
                } else {
                    div.innerHTML = '<em>Waiting...</em>';
                }
                
                lobbyPlayers.appendChild(div);
            }
        }

        function enterGameMode() {
            lobbySection.classList.add('hidden');
            playerGridSection.classList.remove('hidden');
            
            renderPlayerGrid();
        }

        function renderPlayerGrid() {
            const playerGrid = document.getElementById('player-grid');
            playerGrid.innerHTML = '';
            
            currentSession.players.forEach(player => {
                const isCurrentPlayer = player.id === currentPlayerId;
                const section = createPlayerSection(player, isCurrentPlayer);
                playerGrid.appendChild(section);
            });
            
            // Attach color filter event listeners
            attachColorFilterListeners();
        }

        function updatePlayerStatuses() {
            // Update only the status indicators without re-rendering the entire grid
            currentSession.players.forEach(player => {
                const playerSection = document.getElementById(`player-${player.number}`);
                if (!playerSection) return;
                
                const playerStatus = playerSection.querySelector('.player-status');
                if (playerStatus) {
                    playerStatus.textContent = player.commanderLocked ? '🔒 Locked' : 'Selecting...';
                }
                
                // Update locked class
                if (player.commanderLocked) {
                    playerSection.classList.add('locked');
                } else {
                    playerSection.classList.remove('locked');
                }
                
                // Sync commanders from other players if they generated them
                const commandersGrid = document.getElementById(`commanders-${player.number}`);
                if (commandersGrid && (player.commanders || gameModeController.playerCommanderData[player.number])) {
                    // Mark this player as having generated commanders
                    if (player.commanders && player.commanders.length > 0) {
                        playerCommandersGenerated[player.number] = true;
                    }
                    
                    // If player is locked, always show locked commander display
                    if (player.commanderLocked) {
                        console.log(`🔒 [UPDATE] Player ${player.number} is locked - showing locked commander`);
                        commandersGrid.innerHTML = renderCommanders(player);
                    }
                    // Only update if the grid is currently showing "Waiting for commanders..."
                    else if (commandersGrid.querySelector('em')) {
                        console.log(`🔄 [UPDATE] Player ${player.number} generated commanders - rendering them`);
                        commandersGrid.innerHTML = renderCommanders(player);
                    }
                }
            });
        }

        function createPlayerSection(player, isCurrentPlayer) {
            const section = document.createElement('div');
            section.className = 'player-section';
            section.id = `player-${player.number}`;
            
            if (isCurrentPlayer) {
                section.classList.add('current-player');
            }
            
            if (player.commanderLocked) {
                section.classList.add('locked');
            }
            
            const powerup = player.powerup;
            const effects = powerup?.effects || {};
            
            // Calculate quantity
            const baseQuantity = 3;
            const quantityModifier = effects.commanderQuantity || 0;
            const totalQuantity = baseQuantity + quantityModifier;
            
            section.innerHTML = `
                <div class="player-header">
                    <span class="player-number">${player.name || `Player ${player.number}`}${isCurrentPlayer ? ' (You)' : ''}</span>
                    <span class="player-status">${player.commanderLocked ? '🔒 Locked' : 'Selecting...'}</span>
                </div>
                
                <div class="powerup-display ${powerup?.rarity || ''}">
                    <div class="powerup-name">⚡ ${powerup?.name || 'No Powerup'}</div>
                    <div class="powerup-description">${powerup?.description || ''}</div>
                </div>
                
                <div class="player-settings">
                    <div class="setting-row">
                        <span class="setting-label"># of Commander Options:</span>
                        <span class="quantity-display">
                            ${totalQuantity}
                            ${quantityModifier !== 0 ? `<span class="quantity-modifier">(${baseQuantity}${quantityModifier > 0 ? '+' : ''}${quantityModifier})</span>` : ''}
                        </span>
                    </div>
                    ${renderColorFilter(effects)}
                </div>
                
                ${isCurrentPlayer && !player.commanderLocked && !playerCommandersGenerated[player.number] ? `
                    <button class="btn btn-primary" id="generate-btn-${player.number}" onclick="generateCommanders(${player.number}, ${totalQuantity}, ${JSON.stringify(effects).replace(/"/g, '&quot;')})">
                        🎲 Generate Commanders
                    </button>
                ` : ''}
                
                <div class="commander-grid-small" id="commanders-${player.number}">
                    ${player.commanderData ? renderCommanders(player) : '<em>Waiting for commanders...</em>'}
                </div>
                
                ${isCurrentPlayer && !player.commanderLocked && (playerCommandersGenerated[player.number] || gameModeController.playerCommanderData[player.number]?.length > 0 || player.commanders?.length > 0) ? `
                    <button class="btn btn-primary" id="lock-btn-${player.number}" disabled onclick="lockCommander(${player.number})">
                        🔒 Lock In Commander
                    </button>
                ` : ''}
            `;
            
            return section;
        }

        function renderColorFilter(effects) {
            if (!effects.colorFilterMode) return '';
            
            const mode = effects.colorFilterMode;
            const count = effects.colorFilterCount || 0;
            const colors = ['W', 'U', 'B', 'R', 'G'];
            
            let instruction = '';
            if (mode === 'exclude') instruction = `Click to exclude ${count} color${count > 1 ? 's' : ''}`;
            else if (mode === 'include') instruction = `Click to include ${count} color${count > 1 ? 's' : ''}`;
            else if (mode === 'exact') instruction = 'Click to select exact colors';
            
            return `
                <div class="setting-row">
                    <span class="setting-label">Colors:</span>
                    <div class="color-filter-inline" data-mode="${mode}" data-count="${count}">
                        ${colors.map(c => `<div class="color-symbol ${c}" data-color="${c}">${c}</div>`).join('')}
                    </div>
                </div>
                <div class="setting-row">
                    <small style="opacity: 0.7;">${instruction}</small>
                </div>
            `;
        }

        function renderCommanders(player) {
            const isCurrentPlayer = player.id === currentPlayerId;
            
            // Get commanders from session data (sent by the player who generated them)
            let commanders = player.commanders;
            
            // Fall back to local data if available
            if (!commanders || commanders.length === 0) {
                commanders = gameModeController.playerCommanderData[player.number];
            }

            // Debug logging for locked state
            console.log(`🎨 [RENDER-P${player.number}] Render check - Locked: ${player.commanderLocked}, SelectedIndex: ${player.selectedCommanderIndex}, HasCommanders: ${!!commanders}, CommandersLength: ${commanders?.length}`);

            // If player is locked, show their selected commander in large format
            if (player.commanderLocked && commanders) {
                // Get selected commander index from session or local state
                let selectedIndex = player.selectedCommanderIndex;
                if (selectedIndex === undefined) {
                    selectedIndex = gameModeController.playerSelectedCommander[player.number];
                }
                
                console.log(`🔒 [RENDER-P${player.number}] Lock check - SessionIndex: ${player.selectedCommanderIndex}, LocalIndex: ${gameModeController.playerSelectedCommander[player.number]}, Using: ${selectedIndex}`);
                
                if (selectedIndex !== undefined && commanders[selectedIndex]) {
                    const selectedCommander = commanders[selectedIndex];
                    console.log(`🔒 [RENDER-P${player.number}] Showing locked commander:`, selectedCommander);
                    return `
                        <div class="locked-commander-display">
                            <h3>🔒 Locked Commander</h3>
                            <div class="commander-item-large">
                                <img src="${selectedCommander.image_url || 'images/card-back.png'}" 
                                     alt="${selectedCommander.name}" 
                                     class="commander-img-large"
                                     data-edhrec-url="${selectedCommander.edhrec_url || ''}"
                                     onclick="openCommanderLink('${selectedCommander.edhrec_url || ''}')"
                                     title="Click to view on EDHRec">
                                <div class="commander-details">
                                    <h4>${selectedCommander.name}</h4>
                                <p>Rank: ${selectedCommander.rank}</p>
                                <a href="${selectedCommander.edhrec_url || '#'}" target="_blank" class="edhrec-link">View on EDHRec</a>
                            </div>
                        </div>
                    </div>
                `;
                } else {
                    console.log(`⚠️ [RENDER-P${player.number}] Locked but no valid selected commander found`);
                }
            }
            
            if (!commanders || commanders.length === 0) {
                return '<em>Waiting for commanders...</em>';
            }
            
            let html = '';
            commanders.forEach((commander, index) => {
                const isSelected = gameModeController.playerSelectedCommander[player.number] === index;
                html += `
                    <div class="commander-item-small ${isSelected ? 'selected' : ''}" id="commander-${player.number}-${index}">
                        <img src="${commander.image_url || 'images/card-back.png'}" 
                             alt="${commander.name}" 
                             class="commander-img-small"
                             data-edhrec-url="${commander.edhrec_url || ''}"
                             onclick="openCommanderLink('${commander.edhrec_url || ''}')"
                             title="${commander.name} (Rank: ${commander.rank})">
                        <div class="commander-checkbox-container">
                            <label class="commander-checkbox-label ${!isCurrentPlayer ? 'other-player' : ''}">
                                ${isCurrentPlayer ? `
                                    <input type="checkbox" 
                                           class="commander-checkbox" 
                                           name="commander-select-${player.number}" 
                                           ${isSelected ? 'checked' : ''}
                                           onchange="selectCommander(${player.number}, ${index}, this)">
                                ` : ''}
                                <span class="commander-name-label" title="${commander.name}">${commander.name}</span>
                            </label>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        window.generateCommanders = async function(playerNumber, quantity, effects) {
            console.log(`🎲 [GEN-P${playerNumber}] Generate commanders clicked - Quantity: ${quantity}, Effects:`, effects);
            
            const playerSection = document.getElementById(`player-${playerNumber}`);
            const commandersGrid = document.getElementById(`commanders-${playerNumber}`);
            const colorFilterContainer = playerSection.querySelector('.color-filter-inline');
            
            showStatus(`Generating ${quantity} commanders for Player ${playerNumber}...`);
            
            try {
                // Get color selections from UI if applicable
                console.log(`🎨 [GEN-P${playerNumber}] Checking for color filter selections...`);
                const colorSelections = gameModeController.getColorSelectionsFromUI(colorFilterContainer);
                console.log(`🎨 [GEN-P${playerNumber}] Color selections:`, colorSelections);
                
                // Generate commanders
                console.log(`📡 [GEN-P${playerNumber}] Calling generateCommandersForPlayer...`);
                const commanders = await gameModeController.generateCommandersForPlayer(
                    playerNumber,
                    effects,
                    colorSelections
                );
                console.log(`✅ [GEN-P${playerNumber}] Generated ${commanders.length} commanders:`, commanders);
                
                // Render commanders in grid
                console.log(`🎨 [GEN-P${playerNumber}] Rendering commander grid...`);
                commandersGrid.innerHTML = '';
                commanders.forEach((commander, index) => {
                    const item = document.createElement('div');
                    item.className = 'commander-item-small';
                    item.id = `commander-${playerNumber}-${index}`;
                    
                    item.innerHTML = `
                        <img src="${commander.image_url || 'images/card-back.png'}" 
                             alt="${commander.name}" 
                             class="commander-img-small"
                             data-edhrec-url="${commander.edhrec_url || ''}"
                             onclick="openCommanderLink('${commander.edhrec_url || ''}')"
                             title="${commander.name} (Rank: ${commander.rank})">
                        <div class="commander-checkbox-container">
                            <label class="commander-checkbox-label">
                                <input type="checkbox" 
                                       class="commander-checkbox" 
                                       name="commander-select-${playerNumber}" 
                                       onchange="selectCommander(${playerNumber}, ${index}, this)">
                                <span class="commander-name-label" title="${commander.name}">${commander.name}</span>
                            </label>
                        </div>
                    `;
                    
                    commandersGrid.appendChild(item);
                });
                
                console.log(`✅ [GEN-P${playerNumber}] Commander grid rendered`);
                showStatus(`Generated ${commanders.length} commanders for Player ${playerNumber}`);
                
                // Mark player as having generated commanders
                playerCommandersGenerated[playerNumber] = true;
                console.log(`📝 [GEN-P${playerNumber}] Marked as generated, state:`, playerCommandersGenerated);
                
                // Hide the generate button and show the lock button
                const generateBtn = document.getElementById(`generate-btn-${playerNumber}`);
                if (generateBtn) {
                    generateBtn.style.display = 'none';
                }
                
                // Show the lock button if it doesn't exist
                const playerSection = document.getElementById(`player-${playerNumber}`);
                let lockBtn = document.getElementById(`lock-btn-${playerNumber}`);
                if (!lockBtn && playerSection) {
                    console.log(`🔓 [GEN-P${playerNumber}] Creating lock button...`);
                    lockBtn = document.createElement('button');
                    lockBtn.className = 'btn btn-primary';
                    lockBtn.id = `lock-btn-${playerNumber}`;
                    lockBtn.disabled = true;
                    lockBtn.onclick = () => lockCommander(playerNumber);
                    lockBtn.textContent = '🔒 Lock In Commander';
                    playerSection.appendChild(lockBtn);
                }
                
                // Send commanders to server in background (don't await - let it happen async)
                console.log(`📡 [GEN-P${playerNumber}] Syncing commanders to server...`);
                sessionManager.updateCommanders(commanders)
                    .then(() => {
                        console.log(`✅ [GEN-P${playerNumber}] Commanders synced to server`);
                    })
                    .catch(error => {
                        console.warn(`⚠️ [GEN-P${playerNumber}] Failed to sync commanders:`, error.message);
                        // Don't show error to user - local commanders are already displayed
                    });
                
            } catch (error) {
                console.error(`❌ [GEN-P${playerNumber}] Error generating commanders:`, error);
                showStatus(`Error generating commanders: ${error.message}`);
                commandersGrid.innerHTML = '<em style="color: #f44336;">Error loading commanders. Please try again.</em>';
            }
        };

        window.selectCommander = function(playerNumber, commanderIndex, checkbox) {
            // Find the current player's number from their ID
            const currentPlayer = currentSession.players.find(p => p.id === currentPlayerId);
            const currentPlayerNumber = currentPlayer ? currentPlayer.number : null;
            
            // Only allow current player to select commanders
            if (playerNumber !== currentPlayerNumber) {
                console.log(`🚫 [SELECT-P${playerNumber}] Blocked - Not current player number (${currentPlayerNumber}, ID: ${currentPlayerId})`);
                checkbox.checked = !checkbox.checked; // Revert the change
                return;
            }
            
            // Prevent selection if player is already locked
            if (currentPlayer && currentPlayer.commanderLocked) {
                console.log(`🔒 [SELECT-P${playerNumber}] Blocked - Player is already locked`);
                checkbox.checked = !checkbox.checked; // Revert the change
                return;
            }
            
            console.log(`✅ [SELECT-P${playerNumber}] Commander ${commanderIndex} ${checkbox.checked ? 'selected' : 'deselected'}`);
            
            // Uncheck all other checkboxes for this player
            const checkboxes = document.querySelectorAll(`input[name="commander-select-${playerNumber}"]`);
            checkboxes.forEach((cb, idx) => {
                if (idx !== commanderIndex) {
                    cb.checked = false;
                    const item = document.getElementById(`commander-${playerNumber}-${idx}`);
                    if (item) item.classList.remove('selected');
                }
            });
            
            // Update selected state
            const item = document.getElementById(`commander-${playerNumber}-${commanderIndex}`);
            if (checkbox.checked) {
                console.log(`🎯 [SELECT-P${playerNumber}] Marking commander ${commanderIndex} as selected`);
                item.classList.add('selected');
                gameModeController.selectCommander(playerNumber, commanderIndex);
                
                // Enable lock button
                const lockBtn = document.getElementById(`lock-btn-${playerNumber}`);
                if (lockBtn) {
                    lockBtn.disabled = false;
                    console.log(`🔓 [SELECT-P${playerNumber}] Lock button enabled`);
                }
            } else {
                item.classList.remove('selected');
                
                // Disable lock button
                const lockBtn = document.getElementById(`lock-btn-${playerNumber}`);
                if (lockBtn) {
                    lockBtn.disabled = true;
                    console.log(`🔒 [SELECT-P${playerNumber}] Lock button disabled`);
                }
            }
        };

        window.openCommanderLink = function(url) {
            if (url && url.trim() !== '') {
                console.log('🔗 [LINK] Opening commander EDHRec page:', url);
                window.open(url, '_blank');
            } else {
                console.log('⚠️ [LINK] No URL available for this commander');
            }
        };

        window.lockCommander = async function(playerNumber) {
            console.log(`🔒 [LOCK-P${playerNumber}] Lock commander clicked`);
            
            // Check if player is already locked
            const player = currentSession.players.find(p => p.number === playerNumber);
            if (player && player.commanderLocked) {
                console.log(`🚫 [LOCK-P${playerNumber}] Blocked - Player is already locked`);
                showStatus('Commander already locked!');
                return;
            }
            
            showStatus(`Locking commander for Player ${playerNumber}...`);
            
            try {
                console.log(`📡 [LOCK-P${playerNumber}] Calling lockCommanderForPlayer...`);
                const session = await gameModeController.lockCommanderForPlayer(playerNumber);
                console.log(`✅ [LOCK-P${playerNumber}] Commander locked, session updated:`, session);
                
                currentSession = session;
                gameModeController.currentSession = session;
                
                // Update UI to show locked state
                const playerSection = document.getElementById(`player-${playerNumber}`);
                playerSection.classList.add('locked');
                
                const playerStatus = playerSection.querySelector('.player-status');
                if (playerStatus) playerStatus.textContent = '🔒 Locked';
                
                // Update the commanders grid to show large locked commander
                const commandersGrid = document.getElementById(`commanders-${playerNumber}`);
                if (commandersGrid) {
                    const lockedPlayer = currentSession.players.find(p => p.number === playerNumber);
                    if (lockedPlayer) {
                        console.log(`🎨 [LOCK-P${playerNumber}] Updating grid to show locked commander`);
                        commandersGrid.innerHTML = renderCommanders(lockedPlayer);
                    }
                }
                
                // Disable and hide lock button
                const lockBtn = document.getElementById(`lock-btn-${playerNumber}`);
                if (lockBtn) {
                    lockBtn.disabled = true;
                    lockBtn.textContent = '🔒 Commander Locked';
                    lockBtn.style.display = 'none'; // Hide the button completely
                }
                
                console.log(`✅ [LOCK-P${playerNumber}] UI updated`);
                showStatus('Commander locked! Waiting for other players...');
                
                // Check if all locked
                const allLocked = gameModeController.allPlayersLocked();
                console.log(`🔍 [LOCK-P${playerNumber}] All players locked:`, allLocked);
                if (allLocked) {
                    console.log(`🎉 [LOCK-P${playerNumber}] All players locked! Showing pack codes...`);
                    showPackCodes();
                }
            } catch (error) {
                console.error(`❌ [LOCK-P${playerNumber}] Error locking commander:`, error);
                showStatus(`Error locking commander: ${error.message}`);
            }
        };

        function attachColorFilterListeners() {
            document.querySelectorAll('.color-filter-inline').forEach(container => {
                const mode = container.dataset.mode;
                const maxCount = parseInt(container.dataset.count) || 0;
                
                container.querySelectorAll('.color-symbol').forEach(symbol => {
                    symbol.addEventListener('click', () => {
                        const isSelected = symbol.classList.contains('selected');
                        
                        if (mode === 'exclude' || mode === 'include') {
                            // Count currently selected
                            const selectedCount = container.querySelectorAll('.color-symbol.selected').length;
                            
                            if (isSelected) {
                                // Deselect
                                symbol.classList.remove('selected');
                            } else {
                                // Select if under limit
                                if (selectedCount < maxCount) {
                                    symbol.classList.add('selected');
                                }
                            }
                        } else if (mode === 'exact') {
                            // Exact mode: toggle freely
                            symbol.classList.toggle('selected');
                        }
                    });
                });
            });
        }

        function startPolling() {
            console.log('🔄 [POLLING] Starting session polling (2s interval)');
            
            setInterval(async () => {
                if (!currentSession) {
                    console.log('⚠️ [POLLING] No current session - skipping poll');
                    return;
                }
                
                try {
                    console.log(`📡 [POLLING] Fetching session: ${currentSession.sessionCode}`);
                    const session = await sessionManager.getSession(currentSession.sessionCode);
                    console.log('✅ [POLLING] Session updated:', session);
                    
                    currentSession = session;
                    gameModeController.currentSession = session;
                    
                    // Update lobby if in lobby state
                    if (session.state === 'waiting' && !lobbySection.classList.contains('hidden')) {
                        console.log('👥 [POLLING] Updating lobby player list');
                        updateLobbyPlayers();
                    }
                    
                    // Update UI based on state
                    if (session.state === 'selecting' && playerGridSection.classList.contains('hidden')) {
                        console.log('🎮 [POLLING] State is selecting - entering game mode');
                        enterGameMode();
                    }
                    
                    // Update player grid if in selecting state (but only update changed parts)
                    if (session.state === 'selecting' && !playerGridSection.classList.contains('hidden')) {
                        console.log('🔄 [POLLING] Updating player statuses');
                        updatePlayerStatuses();
                    }
                    
                    // Check if all locked
                    const allLocked = gameModeController.allPlayersLocked();
                    console.log(`🔍 [POLLING] All locked: ${allLocked}, State: ${session.state}`);
                    if (allLocked && session.state === 'complete') {
                        console.log('🎉 [POLLING] All locked and complete - showing pack codes');
                        showPackCodes();
                    }
                } catch (error) {
                    console.error('❌ [POLLING] Error:', error);
                }
            }, 2000);
        }

        function showPackCodes() {
            console.log('📦 [PACK-CODES] Showing pack codes section');
            
            playerGridSection.classList.add('hidden');
            packCodesSection.classList.remove('hidden');
            console.log('🔄 [PACK-CODES] View switched - grid hidden, codes shown');
            
            const packCodeList = document.getElementById('pack-code-list');
            packCodeList.innerHTML = '';
            
            console.log('🎨 [PACK-CODES] Rendering pack codes for players:', currentSession.players);
            currentSession.players.forEach((player, index) => {
                console.log(`👤 [PACK-CODES] Player ${player.number}:`, player);
                const div = document.createElement('div');
                div.className = 'pack-code-item';
                div.innerHTML = `
                    <div>
                        <strong>Player ${player.number}:</strong>
                        <div class="pack-code">${player.packCode || 'Generating...'}</div>
                    </div>
                    <button class="btn btn-small" onclick="copyPackCode('${player.packCode}')">Copy</button>
                `;
                packCodeList.appendChild(div);
                console.log(`✅ [PACK-CODES] Player ${player.number} code rendered`);
            });
            
            console.log('✅ [PACK-CODES] All pack codes rendered');
        }

        window.copyPackCode = function(code) {
            console.log('📋 [COPY] Copying pack code:', code);
            navigator.clipboard.writeText(code);
            showStatus('Pack code copied!');
            console.log('✅ [COPY] Pack code copied to clipboard');
        };

        function showStatus(message) {
            console.log(`📢 [STATUS] ${message}`);
            statusMessage.textContent = message;
            setTimeout(() => {
                if (statusMessage.textContent === message) {
                    statusMessage.textContent = '';
                }
            }, 3000);
        }

        // Start initialization
        init();
    </script>
</body>
</html>
